# 섹션 2. 도메인 분석 설계

## 요구사항 분석

회원

상품

주문

3개가 연관돼있다!



기타 요구

- 상품은 재고 관리 필요
- 상품의 종류는 도서, 음반, 영화가 있음
- 상품을 카테고리로 구분 가능
- 상품 주문 배송 정보 입력 가능



## 도메인 모델과 테이블 설계

회원은 여러 상품 주문 가능.

한 번 주문할 때 여러 상품 선택 가능 -> 주문과 상품은 다대다 관계

이런 다대다 관계는 DB는 물론이고 엔티티에서도 거의 사용 X,  주문상품이라는 엔티티를 추가해서 다대다 관계를 일대다, 다대일 관계로 풀어냈다

상품은 도서, 음반, 영화로 구분되는데 상품이라는 공통 속성을 사용하므로 상속 구조로!



양방향 연관관계 : 안 좋다. 단방향 위주로 엔티티 설계를 해야한다



도메인 설계 -> 엔티티 -> 테이블 -> etc

**객체(엔티티)는 다대다 가능, DB는 매핑 테이블 필요** : 실무 쓰지 마



**연관관계 매핑! 매우 중요!!!**

- 서로 다른 테이블에서 관계를 넣을때, 서로 다른 테이블끼리는 직접 관계가 없어도 된다.
- item과 order 중간에  OrderItem을 만든다
- Item에서는 orderitem을 참조할 필요가 없음. 



**외래 키가 있는 곳을 연관관계의 주인으로 정해라**

자동차 바퀴, 자동차(1) : 바퀴(N), 바퀴를 주인으로!!!!!

자동차를 연관관계의 주인으로 설정 -> 바퀴가 바뀌면 이상해지는 경우가 많다!

## 엔티티 클래스 개발1



실무 : setter는 필요한 경우만 연



서로 참조하는 경우, 한 쪽에 테이블 변경 있을때 JPA는 누굴 믿고 해야하지?

- 주인 필요
- 대충 foreign key 있는 곳이 주인



### cf) N : 1 이면, (ManyToOne)

- 내가 많다는 거
- OneToMany(1:N) 에서는 리스트를 가지고 있어서 select 할 떄 쓴다, 근데 여기선 수정 불가
- ManyToOne(N:1) 여기서 수정 가능, 주도권은 ManyToOne!



(N:1) joinColumn : 기본키 기준!,  내가 주인공이니까 이거 기준으로 조인해!

(1:N)mappedBy : 의미상 어디에 매칭되는지( 나는 서브니까 어느걸 기준으로 하는지~)



(1:1) 조회 많이 하는걸 기준으로 외래키를 두는 편(주인)

## 엔티티 클래스 개발 2

꼭 외래키를 적용해야하는 건 아냐!

만약 프로그램 실행만 원해 -> 인덱스만 잘 설정

정합성이 필요 -> 외래키까지 설정해야한다, 그러나 비용 문제가 있을 수 있다!



Entity에서는 객체.id로 식별자를 구분할 수 있지만

테이블은 타입이 없어서 **필드만으로 구분할 수 없다**, 그래서 colume_name을 table명 + id로!



JPA 기본 DDL : 나중에 대충 보고, 미세 조정해야할 부분 있을거



## 엔티티 설계시 주의점



- **SETTER X**
- **모든 연관관계는 지연로딩으로 설정!!!!!!!!!!!!**
  - 수많은 장애 극복(암기)
  - 즉시 로딩(EAGER) -> 예측이 어렵고, 어떤 SQL이 실행될지 모름 (연관된 모든 데이터가 한 번에 가져올 수 있어서 망할 떄가 있다)
    **모든 연관관계는 지연 로딩(LAZY)으로 설정**
  - **연관된 엔티티를 함꼐 DB에서 조회, fetch join 또는 엔티티 그래프 기능 사용!**
  - **@XtoOne 관계는 기본이 EAGER, -> LAZY로 바꿔야 함**
- **컬렉션은 필드에서 초기화**
  - null 문제에서 안전
  - 하이버네이트 엔티티 영속화, 컬렉션을 감쌈 => 하이버네티으 제공하는 내장 컬랙션으로 변경



#### 테이블, 컬럼명 생성 전략

orderDate -> order_date 로 바뀐다~(테이블로)

자바의 카멜케이스는 소문자, _로 연결



Cascade : 따로 해야하는 걸 한 번에 해줌 ( ALL )

